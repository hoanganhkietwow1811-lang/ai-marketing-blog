import React, { useEffect, useState } from 'react';
import { useParams, Link } from 'react-router-dom';
import { Calendar, Eye, EyeOff, Loader2, ArrowLeft } from 'lucide-react';
import { BLOG_POSTS } from '../data/mockData'; // üëá Import th√™m Mock Data ƒë·ªÉ xem b√†i c≈©

// ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu
interface BlogPost {
  id: string;
  title: string;
  subtitle: string;
  category: string;
  image: string;
  date: string;
  readTime: string;
  content: {
    intro: string;
    keyPoints: string[];
    sections: { heading: string; body: string }[]; // C·∫•u tr√∫c UI c·∫ßn
    takeaways: string;
  };
  author?: { name: string };
}

const PostDetail: React.FC = () => {
  const { id } = useParams<{ id: string }>(); 
  const [post, setPost] = useState<BlogPost | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  
  const [deepDiveMode, setDeepDiveMode] = useState(false);
  const [readingProgress, setReadingProgress] = useState(0);

  useEffect(() => {
    const fetchPostDetail = async () => {
      setIsLoading(true);
      
      if (!id) return;

      // üëá LOGIC QUAN TR·ªåNG: Ki·ªÉm tra xem ƒë√¢y l√† b√†i Real (DB) hay Mock (M·∫´u)
      const isRealPost = id.startsWith('real-');

      if (isRealPost) {
        // --- TR∆Ø·ªúNG H·ª¢P 1: B√ÄI VI·∫æT T·ª™ DATABASE ---
        try {
          // 1. C·∫Øt b·ªè ch·ªØ "real-" ƒë·ªÉ l·∫•y ID g·ªëc (VD: "real-15" -> "15")
          const dbId = id.replace('real-', '');
          
          console.log(`üì° ƒêang l·∫•y b√†i t·ª´ Server v·ªõi ID g·ªëc: ${dbId}`);
          
          // G·ªçi API (D√πng api/posts l√† ƒë·ªß, ho·∫∑c t·∫°o api get detail ri√™ng)
          // ·ªû ƒë√¢y m√¨nh d√πng c√°ch ƒë∆°n gi·∫£n l√† l·∫•y list r·ªìi t√¨m, t·ªëi ∆∞u h∆°n l√† g·ªçi api/posts/:id
          const response = await fetch('http://localhost:4000/api/posts'); 
          const data = await response.json();
          
          const foundPostDB = data.find((p: any) => p.id.toString() === dbId);

          if (foundPostDB) {
            // 2. Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu ph·∫≥ng t·ª´ DB sang c·∫•u tr√∫c ph√¢n t·∫ßng c·ªßa UI
            setPost({
              id: id, // Gi·ªØ nguy√™n ID tr√™n URL
              title: foundPostDB.title,
              subtitle: "Deep dive into strategy mechanics",
              category: foundPostDB.category || "Strategy",
              image: foundPostDB.image || "https://source.unsplash.com/random",
              date: new Date(foundPostDB.createdAt).toLocaleDateString(),
              readTime: "5 min read",
              author: { name: "Tri Bui" }, // Ho·∫∑c l·∫•y t·ª´ foundPostDB.authorId
              content: {
                // Intro l·∫•y ƒëo·∫°n ƒë·∫ßu
                intro: foundPostDB.content ? foundPostDB.content.substring(0, 200) + "..." : "",
                keyPoints: ["AI Generated Analysis", "Strategic Overview"],
                // üëá QUAN TR·ªåNG: Nh√©t to√†n b·ªô n·ªôi dung v√†o 1 section ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß
                sections: [
                  { 
                    heading: "Full Analysis", 
                    body: foundPostDB.content // Hi·ªÉn th·ªã to√†n b·ªô n·ªôi dung Markdown
                  }
                ],
                takeaways: "This content is generated by AI Agent."
              }
            });
          }
        } catch (error) {
          console.error("‚ùå L·ªói API:", error);
        }
      } else {
        // --- TR∆Ø·ªúNG H·ª¢P 2: B√ÄI VI·∫æT M·∫™U (MOCK DATA) ---
        console.log("üìÇ ƒêang t√¨m trong Mock Data...");
        const foundMock = BLOG_POSTS.find(p => p.id === id);
        if (foundMock) {
            // √âp ki·ªÉu v·ªÅ interface BlogPost c·ªßa component n√†y (n·∫øu l·ªách type)
            // ·ªû ƒë√¢y m√¨nh gi·∫£ s·ª≠ c·∫•u tr√∫c Mock Data ƒë√£ kh·ªõp
            setPost(foundMock as unknown as BlogPost);
        }
      }

      setIsLoading(false);
    };

    fetchPostDetail();
  }, [id]);

  // Logic Scroll Progress
  useEffect(() => {
    const handleScroll = () => {
      const total = document.documentElement.scrollTop;
      const windowHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      setReadingProgress(total / windowHeight);
    }
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  if (isLoading) return <div className="min-h-screen flex justify-center items-center"><Loader2 className="animate-spin"/></div>;

  if (!post) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center dark:text-white">
        <h2 className="text-2xl font-bold mb-4">404 - Post Not Found</h2>
        <p className="mb-4 text-slate-500">Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt c√≥ ID: {id}</p>
        <Link to="/" className="text-blue-500 hover:underline flex items-center">
          <ArrowLeft size={20} className="mr-2"/> Quay l·∫°i Trang ch·ªß
        </Link>
      </div>
    );
  }

  return (
    <div className={`transition-colors duration-700 ease-in-out ${deepDiveMode ? 'bg-zinc-950 text-slate-300' : 'bg-white dark:bg-black text-slate-800 dark:text-slate-200'}`}>
      <div className="fixed top-0 left-0 h-1 bg-black dark:bg-white z-[60] w-full origin-left transform" style={{ transform: `scaleX(${readingProgress})` }}></div>
      
      <div className="fixed right-8 top-1/2 -translate-y-1/2 z-40 hidden xl:flex flex-col space-y-4">
        <button onClick={() => setDeepDiveMode(!deepDiveMode)} className={`p-3 rounded-full shadow-lg transition-all ${deepDiveMode ? 'bg-white text-black' : 'bg-black text-white'}`}>
            {deepDiveMode ? <EyeOff size={20} /> : <Eye size={20} />}
        </button>
      </div>

      {!deepDiveMode && (
        <div className="relative h-[60vh]">
            <img src={post.image} alt={post.title} className="w-full h-full object-cover filter brightness-50"/>
            <div className="absolute inset-0 flex items-center justify-center text-center p-4">
                <div className="max-w-4xl text-white">
                    <span className="border border-white/50 px-4 py-1 text-xs font-bold uppercase tracking-widest mb-6 inline-block">{post.category}</span>
                    <h1 className="text-4xl md:text-6xl font-serif font-bold mb-6">{post.title}</h1>
                    <div className="flex justify-center gap-6 text-sm font-bold uppercase tracking-widest opacity-80">
                        <span className="flex items-center"><Calendar size={14} className="mr-2"/> {post.date}</span>
                        {post.author && <span>By {post.author.name}</span>}
                    </div>
                </div>
            </div>
        </div>
      )}

      <div className={`max-w-3xl mx-auto px-4 py-20 relative`}>
        {/* Intro Section */}
        {post.content.intro && (
            <p className="text-2xl font-serif leading-relaxed mb-12 italic opacity-80">
                "{post.content.intro}"
            </p>
        )}
        
        {/* Main Content Render */}
        <div className="prose prose-lg dark:prose-invert max-w-none">
            {post.content.sections.map((sec, idx) => (
                <div key={idx} className="mb-10">
                    {/* Ch·ªâ hi·ªán heading n·∫øu kh√¥ng ph·∫£i l√† Full Analysis (ƒë·ªÉ ƒë·ª° l·∫∑p) */}
                    {sec.heading !== "Full Analysis" && <h3>{sec.heading}</h3>}
                    
                    {/* üëá S·ª¨ D·ª§NG white-space-pre-wrap ƒê·ªÇ GI·ªÆ XU·ªêNG D√íNG C·ª¶A AI */}
                    <div className="whitespace-pre-wrap font-sans text-lg leading-8">
                        {sec.body}
                    </div>
                </div>
            ))}
        </div>
      </div>
    </div>
  );
};

export default PostDetail;